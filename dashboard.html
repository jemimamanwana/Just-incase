<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GeneShield | Dashboard</title>
  <link rel="stylesheet" href="css/dashboard.css" />
  <style>
    /* Hide everything until auth is confirmed — prevents flash of protected content */
    body.auth-pending { visibility: hidden; }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet" />
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.2/jspdf.umd.min.js"></script>
</head>
<body class="auth-pending">

  <aside class="sidebar" id="sidebar">
    <div class="sidebar-brand">
      <img src="logo GeneSheild" alt="GeneShield" style="height:36px;width:36px;border-radius:50%;object-fit:cover;">
      <span class="brand-name">Gene<span class="brand-accent">Shield</span></span>
    </div>
    <nav class="sidebar-nav">
      <a href="dashboard.html" class="nav-item active"><i class='bx bx-grid-alt'></i><span>Dashboard</span></a>
      <a href="vitals.html" class="nav-item"><i class='bx bx-pulse'></i><span>Log Vitals</span></a>
      <a href="chat.html" class="nav-item"><i class='bx bx-bot'></i><span>AI Companion</span></a>
      <a href="#" class="nav-item" onclick="event.preventDefault(); generatePDFReport()"><i class='bx bx-dna'></i><span>Risk Report</span></a>
      <a href="onboarding.html" class="nav-item"><i class='bx bx-user'></i><span>Profile</span></a>
    </nav>
    <div class="sidebar-footer">
      <a href="#" class="nav-item logout" id="logoutBtn"><i class='bx bx-log-out'></i><span>Logout</span></a>
    </div>
  </aside>

  <main class="main-content">
    <header class="topbar">
      <div class="topbar-left">
        <button class="menu-toggle" id="menuToggle"><i class='bx bx-menu'></i></button>
        <div>
          <h1 class="page-title">Dashboard</h1>
        </div>
      </div>
      <button class="generate-report-btn" onclick="generatePDFReport()" style="display:inline-flex;align-items:center;gap:8px;background:linear-gradient(135deg,#00b5ff,#0090cc);border:none;color:#fff;padding:10px 20px;border-radius:50px;font-size:0.85rem;font-weight:700;cursor:pointer;font-family:inherit;box-shadow:0 4px 15px rgba(0,181,255,0.3);transition:all 0.2s ease;">
        <i class='bx bx-download'></i> Generate PDF Report
      </button>
    </header>

    <div class="dashboard-body">

      <div class="greeting-card">
        <div class="greeting-text">
          <h2 id="greetingMsg">Good morning</h2>
          <p>Here's your cancer risk overview. You have <strong>screening recommendations</strong> from your AI companion.</p>
        </div>
        <a href="vitals.html" class="btn-log"><i class='bx bx-plus'></i> Log Today's Vitals</a>
      </div>

      <!-- WHY EARLY DETECTION MATTERS — Botswana Cancer Statistics -->
      <section class="stats-pillars">
        <h3 class="pillars-title"><i class='bx bx-info-circle'></i> Why Early Detection Matters</h3>
        <div class="pillars-grid">
          <div class="pillar-card">
            <div class="pillar-icon"><i class='bx bx-search-alt'></i></div>
            <div class="pillar-stat">36%</div>
            <div class="pillar-label">of cancers staged as "unknown"</div>
            <p class="pillar-desc">Most Batswana discover cancer at advanced stages (III/IV). Only <strong>8.4%</strong> are caught at Stage I.</p>
            <span class="pillar-source">Princess Marina Hospital study, JCO Global Oncology 2019</span>
          </div>
          <div class="pillar-card">
            <div class="pillar-icon"><i class='bx bx-female'></i></div>
            <div class="pillar-stat">44.7%</div>
            <div class="pillar-label">cervical cancer patients present late-stage</div>
            <p class="pillar-desc"><strong>69.7%</strong> of those women are also living with HIV, compounding their risk.</p>
            <span class="pillar-source">Friebel-Klingner et al., BMC Women's Health 2021</span>
          </div>
          <div class="pillar-card">
            <div class="pillar-icon"><i class='bx bx-male'></i></div>
            <div class="pillar-stat">67%</div>
            <div class="pillar-label">of men with cancer present at Stage III/IV</div>
            <p class="pillar-desc">Men wait an average of <strong>8.4 months</strong> from first symptoms to treatment.</p>
            <span class="pillar-source">Iyer et al., PLOS ONE 2019</span>
          </div>
        </div>
      </section>

      <section class="section-block">
        <div class="section-title-row">
          <h3 class="section-title">Hereditary Cancer Risk Assessment</h3>
          <span class="section-tag">AI-Generated</span>
        </div>
        <div class="risk-grid" id="riskGrid">
          <div class="risk-loading">
            <i class='bx bx-loader-alt'></i>
            <p>Loading your risk assessment...</p>
          </div>
        </div>
      </section>

      <!-- ML MODEL PERFORMANCE -->
      <section class="section-block">
        <div class="section-title-row">
          <h3 class="section-title">ML Model Performance</h3>
          <span class="section-tag">Trained on Real Datasets</span>
        </div>
        <div class="model-perf-grid">
          <div class="model-perf-card">
            <div class="mpc-icon prostate"><i class='bx bx-male'></i></div>
            <div class="mpc-info">
              <h4>Prostate Cancer Model</h4>
              <p class="mpc-algo">GradientBoostingClassifier · GridSearchCV 3-fold</p>
              <p class="mpc-dataset">Trained on Prostate_Cancer.csv (100 samples, 10 features)</p>
            </div>
            <div class="mpc-scores">
              <div class="mpc-score"><span class="mpc-val">85.51%</span><span class="mpc-label">Accuracy</span></div>
              <div class="mpc-score"><span class="mpc-val">84.86%</span><span class="mpc-label">F1 Score</span></div>
            </div>
          </div>
          <div class="model-perf-card">
            <div class="mpc-icon cervical"><i class='bx bx-female'></i></div>
            <div class="mpc-info">
              <h4>Cervical Cancer Model</h4>
              <p class="mpc-algo">RandomForestClassifier · class_weight='balanced' · GridSearchCV 3-fold</p>
              <p class="mpc-dataset">Trained on cervical-cancer_csv.csv (835 samples, 16 features)</p>
            </div>
            <div class="mpc-scores">
              <div class="mpc-score"><span class="mpc-val" id="cervicalAcc">--</span><span class="mpc-label">Accuracy</span></div>
              <div class="mpc-score"><span class="mpc-val" id="cervicalF1">--</span><span class="mpc-label">F1 Score</span></div>
            </div>
          </div>
          <div class="model-perf-card">
            <div class="mpc-icon chatbot"><i class='bx bx-bot'></i></div>
            <div class="mpc-info">
              <h4>Medical Chatbot Engine</h4>
              <p class="mpc-algo">TF-IDF Vectorizer · Cosine Similarity Retrieval</p>
              <p class="mpc-dataset">Trained on ai-medical-chatbot.csv (256,917 doctor-patient Q&A pairs)</p>
            </div>
            <div class="mpc-scores">
              <div class="mpc-score"><span class="mpc-val">257K</span><span class="mpc-label">Q&A Pairs</span></div>
              <div class="mpc-score"><span class="mpc-val">Local</span><span class="mpc-label">No API</span></div>
            </div>
          </div>
        </div>
      </section>

      <div class="two-col">
        <section class="section-block">
          <div class="section-title-row">
            <h3 class="section-title">Recent Vitals</h3>
            <a href="vitals.html" class="section-link">View All <i class='bx bx-right-arrow-alt'></i></a>
          </div>
          <div class="vitals-list" id="vitalsList">
            <div class="vital-row">
              <div class="vital-icon bp"><i class='bx bx-pulse'></i></div>
              <div class="vital-info"><span class="vital-name">Blood Pressure</span><span class="vital-date">No data yet</span></div>
              <div class="vital-value"><span class="vital-reading">--/--</span><span class="vital-unit">mmHg</span></div>
              <span class="vital-status ok">--</span>
            </div>
          </div>
          <a href="vitals.html" class="log-vitals-btn"><i class='bx bx-plus-circle'></i> Log New Vitals</a>
        </section>
      </div>

      <section class="section-block">
        <div class="section-title-row">
          <h3 class="section-title">Personalised Cancer Prevention Tips</h3>
          <span class="section-tag">Based on your risk profile</span>
        </div>
        <div class="tips-grid">
          <div class="tip-card red"><i class='bx bx-error-circle'></i><div><strong>Schedule a Mammogram</strong><p>If your breast cancer risk is elevated due to family history, book a mammogram and ask your doctor about BRCA genetic testing.</p></div></div>
          <div class="tip-card yellow"><i class='bx bx-info-circle'></i><div><strong>Get Your Pap Smear</strong><p>Cervical cancer is highly preventable. A Pap smear every 3 years can catch changes before they become cancer.</p></div></div>
          <div class="tip-card green"><i class='bx bx-check-circle'></i><div><strong>Boost Your Diet</strong><p>A high-fibre, plant-rich diet with morogo, sorghum, and less red meat significantly lowers colorectal cancer risk.</p></div></div>
        </div>
      </section>

    </div>
  </main>

  <script src="js/api.js"></script>
  <script src="js/dashboard.js"></script>
  <script>
    const RISK_CARD_CONFIG = {
      breast_cancer: { title: 'Breast Cancer', icon: 'bx-ribbon', tip: 'Schedule a mammogram. Discuss BRCA gene testing with your doctor.' },
      cervical_cancer: { title: 'Cervical Cancer', icon: 'bx-female', tip: 'Get a Pap smear every 3 years. HPV vaccination is highly protective.' },
      prostate_cancer: { title: 'Prostate Cancer', icon: 'bx-male', tip: 'Annual PSA screening from age 50, or 40 if family history present.' },
      colorectal_cancer: { title: 'Colorectal Cancer', icon: 'bx-dna', tip: 'Colonoscopy recommended from age 40. Increase fibre, reduce red meat.' },
    };

    function getRiskLevel(pct) {
      if (pct >= 60) return 'high';
      if (pct >= 40) return 'moderate';
      return 'low';
    }

    function getRiskNote(level, key) {
      if (level === 'high') return 'Family history detected';
      if (level === 'moderate') return 'Risk factor noted';
      return 'No significant risk factors';
    }

    function renderRiskCards(scores) {
      const grid = document.getElementById('riskGrid');
      if (!scores) {
        grid.innerHTML = '<p style="color:var(--gray);text-align:center;padding:20px;">No risk scores available. <a href="onboarding.html" style="color:var(--primary);">Complete your profile</a> to generate your risk assessment.</p>';
        return;
      }

      grid.innerHTML = '';
      for (const [key, config] of Object.entries(RISK_CARD_CONFIG)) {
        const pct = scores[key];
        if (pct === undefined || pct === null) continue;

        const level = getRiskLevel(pct);
        const card = document.createElement('div');
        card.className = `risk-score-card ${level}`;
        card.innerHTML = `
          <div class="rsc-header">
            <div class="rsc-icon"><i class='bx ${config.icon}'></i></div>
            <span class="rsc-badge ${level}">${level.charAt(0).toUpperCase() + level.slice(1)}</span>
          </div>
          <h4>${config.title}</h4>
          <div class="rsc-gauge"><div class="gauge-fill" style="width:0%"></div></div>
          <div class="rsc-stats">
            <span class="rsc-percent">${pct}%</span>
            <span class="rsc-note">${getRiskNote(level, key)}</span>
          </div>
          <p class="rsc-tip">${config.tip}</p>
        `;
        grid.appendChild(card);

        // Animate gauge
        requestAnimationFrame(() => {
          card.querySelector('.gauge-fill').style.width = pct + '%';
        });
      }
    }

    async function loadDashboardData() {
      try {
        const scores = await getLatestRiskScores();
        renderRiskCards(scores);

        // Load vitals
        const vitals = await getVitalsHistory(4);
        if (vitals && vitals.length > 0) {
          const list = document.getElementById('vitalsList');
          list.innerHTML = '';
          const iconMap = { bp: 'bx-pulse', glucose: 'bx-droplet', weight: 'bx-dumbbell', hr: 'bx-heart' };
          vitals.slice(0, 4).forEach(v => {
            const date = v.logged_at ? new Date(v.logged_at).toLocaleDateString() : 'Recently';
            let rows = '';
            if (v.bp_systolic) {
              const bpStatus = v.bp_systolic > 130 ? 'warn' : 'ok';
              rows += `<div class="vital-row"><div class="vital-icon bp"><i class='bx bx-pulse'></i></div><div class="vital-info"><span class="vital-name">Blood Pressure</span><span class="vital-date">${date}</span></div><div class="vital-value"><span class="vital-reading">${v.bp_systolic}/${v.bp_diastolic || '--'}</span><span class="vital-unit">mmHg</span></div><span class="vital-status ${bpStatus}">${bpStatus === 'warn' ? 'Elevated' : 'Normal'}</span></div>`;
            }
            if (v.glucose) {
              const gStatus = v.glucose > 6.9 ? 'warn' : 'ok';
              rows += `<div class="vital-row"><div class="vital-icon glucose"><i class='bx bx-droplet'></i></div><div class="vital-info"><span class="vital-name">Blood Glucose</span><span class="vital-date">${date}</span></div><div class="vital-value"><span class="vital-reading">${v.glucose}</span><span class="vital-unit">mmol/L</span></div><span class="vital-status ${gStatus}">${gStatus === 'warn' ? 'High' : 'Normal'}</span></div>`;
            }
            list.innerHTML += rows;
          });
        }
      } catch (err) {
        console.error('Dashboard load error:', err);
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // Auth gate — redirect to login if not signed in
      const user = await requireAuth();
      if (!user) return; // stop here; requireAuth() already redirects to login.html

      // Auth confirmed — reveal the page
      document.body.classList.remove('auth-pending');

      // Personalise greeting with user's name
      const greetEl = document.getElementById('greetingMsg');
      if (greetEl && user.first_name) {
        const hour = new Date().getHours();
        const timeGreet = hour < 12 ? 'Good morning' : hour < 18 ? 'Good afternoon' : 'Good evening';
        greetEl.textContent = `${timeGreet}, ${user.first_name}`;
      }

      loadDashboardData();

      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          try { await signOut(); } catch { window.location.href = 'login.html'; }
        });
      }
    });
  </script>
</body>
</html>
